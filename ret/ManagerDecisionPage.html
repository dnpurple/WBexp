{% extends "global/Page.html" %}
{% load otree static %}

{% block scripts %}
<script>
/**
 * ManagerDecisionPage interactions
 * - No defaults shown initially
 * - Transfer options only visible if "Yes" to stealing
 * - Must pick Yes/No to stealing; if Yes, must enter 1–50 and pick Yes/No to transfer
 * - Preview blank until a choice is made; shows 0 if "No", computes if "Yes"
 */
(function() {
  const WORKER_POINTS = {{ worker_points_earned|default:0 }};

  function qs(sel){ return document.querySelector(sel); }
  function qsa(sel){ return Array.from(document.querySelectorAll(sel)); }

  function yesChecked() { return !!qs('input[name="wants_to_take"][value="True"]:checked'); }
  function noChecked()  { return !!qs('input[name="wants_to_take"][value="False"]:checked'); }
  function anyChecked() { return !!qs('input[name="wants_to_take"]:checked'); }

  function clearTransferRadios() {
    const yes = qs('input[name="wants_to_pay_transfer"][value="True"]');
    const no  = qs('input[name="wants_to_pay_transfer"][value="False"]');
    if (yes) yes.checked = false;
    if (no)  no.checked  = false;
  }
  function setTransferNo() {
    const yes = qs('input[name="wants_to_pay_transfer"][value="True"]');
    const no  = qs('input[name="wants_to_pay_transfer"][value="False"]');
    if (no)  no.checked  = true;
    if (yes) yes.checked = false;
  }

  function computePreview() {
    const earningsDisplay = qs('#earnings-display');
    const pctInput = qs('#pct-input');
    if (!earningsDisplay || !pctInput) return;

    // If neither Yes nor No selected, show nothing
    if (!anyChecked()) {
      earningsDisplay.textContent = "";
      return;
    }
    // If "No", show 0 preview
    if (noChecked()) {
      earningsDisplay.textContent = `You will receive 0 ECUs (0% of ${WORKER_POINTS}).`;
      return;
    }
    // If "Yes", compute
    const pct = parseInt(pctInput.value, 10);
    if (Number.isInteger(pct) && pct >= 1 && pct <= 50) {
      const amt = Math.round((pct / 100) * WORKER_POINTS);
      earningsDisplay.textContent = `You will receive ${amt} ECUs (${pct}% of ${WORKER_POINTS}).`;
    } else {
      earningsDisplay.textContent = "";
    }
  }

  // Show/hide the theft options panel
  function toggleTakeOptions(show) {
    const takeOptions = qs("#take-options");
    const pctInput    = qs('#pct-input');
    if (!takeOptions || !pctInput) return;

    takeOptions.style.display = show ? "block" : "none";
    pctInput.required = show;

    if (!show) {
      // We do NOT preselect the transfer in the visible UI;
      // keep fields inert and blank; backend defaults are enforced on timeout.
      pctInput.value = "";
      pctInput.disabled = true;
      // If you *want* a hidden backend “No” when explicit No is chosen:
      // setTransferNo();
    } else {
      pctInput.disabled = false;
      if (!pctInput.value || pctInput.value === "0") pctInput.value = "";
      // Make sure the manager SEES no default on transfer when the panel opens
      clearTransferRadios();
    }
    computePreview();
  }

  document.addEventListener("DOMContentLoaded", function() {
    // Initial state: nothing selected; keep panel hidden & inputs inert
    const takeOptions = qs("#take-options");
    const pctInput = qs('#pct-input');
    if (takeOptions) takeOptions.style.display = "none";
    if (pctInput) { pctInput.disabled = true; pctInput.required = false; pctInput.value = ""; }

    // Wire listeners
    const pct = qs('#pct-input');
    if (pct) {
      pct.addEventListener('input', computePreview);
      pct.addEventListener('change', computePreview);
    }
    qsa('input[name="wants_to_take"]').forEach(el => {
      el.addEventListener('change', function() {
        toggleTakeOptions(this.value === "True");
      });
    });

    // Submit-time validation (mirrors server validation)
    const form = document.querySelector("form");
    if (form) {
      form.addEventListener("submit", function(e) {
        const pickYes  = yesChecked();
        const pickNo   = noChecked();
        const picked   = pickYes || pickNo;

        if (!picked) {
          e.preventDefault();
          alert("Please select whether you want to take from the worker's earnings (Yes or No).");
          return;
        }

        if (pickYes) {
          const pctInput = qs('#pct-input');
          const pctVal = pctInput ? parseInt(pctInput.value, 10) : NaN;
          if (!Number.isInteger(pctVal) || pctVal < 1 || pctVal > 50) {
            e.preventDefault();
            alert("Please enter a valid percentage between 1 and 50.");
            return;
          }
          const transferPick = !!qs('input[name="wants_to_pay_transfer"]:checked');
          if (!transferPick) {
            e.preventDefault();
            alert("Please select whether you want to pay a transfer to the authority (Yes or No).");
            return;
          }
        }
      });
    }
  });
})();
</script>

<style>
  input[type="number"] { width: 60px; text-align: center; }
  .input-label-container { display: flex; align-items: center; justify-content: center; gap: 5px; }
  .radio-container {
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    gap: 40px;
    margin: 10px auto;
    width: fit-content;
  }
  .otree-radio-option { margin: 0; display: flex; align-items: center; }
  .otree-radio-option label { margin: 0 5px; }
  .otree-timer {
    background-color: transparent !important;
    color: black !important;
    font-weight: normal;
    border: none;
    padding: 0;
    text-align: right;
  }
</style>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; padding: 10px;">
  <div>
    <p>Your role is: <strong>{{ player.get_role }}</strong></p>
  </div>
  <div style="text-align: center;">
    <h1 style="font-weight: bold; font-size: 20px;">Decision Task</h1>
  </div>
  <div style="text-align: right;">
    <p>Round: {{ player.round_number }} of {{ C.NUM_ROUNDS }}</p>
  </div>
</div>

<p>You earned <strong>{{ points_earned }}</strong> points in the addition task.</p>

<p>
  You have been matched with a worker from one of 3 groups.
  The matched worker solved <strong>{{ worker_solved_problems }}</strong> problems correctly
  and earned <strong>{{ worker_points_earned }}</strong> ECUs in the addition task.
</p>

<!-- Step 1: Do you want to take from the worker's earnings? -->
<p>Do you want to take from the worker's earnings?</p>
<div class="radio-container">
  <label>
    <input type="radio" name="wants_to_take" value="True"> Yes
  </label>
  <label>
    <input type="radio" name="wants_to_take" value="False"> No
  </label>
  {{ formfield_errors 'wants_to_take' }}
</div>

<!-- Step 2: Percentage taken and transfer option (only visible if wants_to_take = Yes) -->
<div id="take-options" style="display: none; margin-top: 20px; text-align: left;">
  <p>
    If you would like to take a percentage of this worker's earnings from the addition task, please enter the amount below.
    You can only take a maximum of 50%.
  </p>

  <div class="input-label-container">
    <label>Percentage Taken</label>
    <input id="pct-input" type="number" name="percentage_taken" min="1" max="50" style="width: 60px; text-align: center;" /> <span>%</span>
  </div>
  {{ formfield_errors 'percentage_taken' }}

  <p id="earnings-display" style="font-weight: bold; margin-top: 10px;"></p>

  <p style="margin-top: 15px;">
    If you have taken from a worker, the worker in your group may make a report in your group.
    You can offer a transfer to the authority to intervene on your behalf.
  </p>
  <ul style="margin-top: 10px;">
    <li>If the authority does not intervene on you, you face a {{ penalty_percentage }}% chance of losing your earnings for this round.</li>
    <li>If the authority intervenes on your behalf, you face a {{ treatment_percentage }}% chance of losing your earnings for this period.</li>
  </ul>

  <div class="transfer-option" style="margin-top: 10px;">
    <p>Do you want to pay a transfer of 60 ECUs to the authority?</p>
    <div class="radio-container">
      <label>
        <input type="radio" name="wants_to_pay_transfer" value="True"> Yes
      </label>
      <label>
        <input type="radio" name="wants_to_pay_transfer" value="False"> No
      </label>
      {{ formfield_errors 'wants_to_pay_transfer' }}
    </div>
  </div>
</div>

<div style="text-align: right; margin-top: 20px;">
  {{ next_button }}
</div>
{% endblock %}
